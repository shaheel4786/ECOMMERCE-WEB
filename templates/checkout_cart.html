{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
    <h2 class="mb-4 text-center">Checkout</h2>

    {% if cart_items %}
    <table class="table table-bordered text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th>Image</th>
                <th>Product Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr>
                <td><img src="{{ url_for('static', filename='images/' ~ item.image) }}" width="100"></td>
                <td>{{ item.name }}</td>
                <td>₹{{ item.price }}</td>
                <td>{{ item.total_quantity }}</td>
                <td>₹{{ item.price * item.total_quantity }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="text-end">
        <h4>Total Amount: ₹{{ total_amount }}</h4>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to Products</a>
        <button id="rzp-button" class="btn btn-lg text-white"
            style="background: linear-gradient(135deg, #f72585 0%, #7209b7 100%);
                   border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            Pay Now
        </button>
        
    </div>

    {% else %}
    <p class="text-center mt-5">Your cart is empty.</p>
    <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg">Continue Shopping</a>
    {% endif %}
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.getElementById('rzp-button').onclick = function(e){
    e.preventDefault();

    // Call Flask route to create order
    fetch("/create_order", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "amount={{ total_amount }}"
    })
    .then(response => response.json())
    .then(data => {
        var options = {
            "key": data.key,
            "amount": data.amount,
            "currency": data.currency,
            "name": "My Shop",
            "description": "Cart Payment",
            "order_id": data.order_id,
            "handler": function (response){
                // Submit payment details to Flask
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/payment_success';
                

                const payment_id_input = document.createElement('input');
                payment_id_input.name = 'razorpay_payment_id';
                payment_id_input.value = response.razorpay_payment_id;
                form.appendChild(payment_id_input);

                const order_id_input = document.createElement('input');
                order_id_input.name = 'razorpay_order_id';
                order_id_input.value = response.razorpay_order_id;
                form.appendChild(order_id_input);

                const signature_input = document.createElement('input');
                signature_input.name = 'razorpay_signature';
                signature_input.value = response.razorpay_signature;
                form.appendChild(signature_input);

                document.body.appendChild(form);
                form.submit();
            },
            "theme": {
                "color": "#f72585"
            }
        };
        var rzp1 = new Razorpay(options);
        rzp1.open();
    });
}
</script>
{% endblock %}
